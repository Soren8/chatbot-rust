<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" {% if sri.bootstrap_css %}integrity="{{ sri.bootstrap_css }}" crossorigin="anonymous"{% else %}crossorigin="anonymous"{% endif %}>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-dark text-light login-page">
    <div class="container login-container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card bg-dark text-light border-secondary">
                    <div class="card-header">
                        <h1 class="text-center mb-0">Login</h1>
                    </div>
                    <div class="card-body">
                        <form action="/login" method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username:</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" name="username" id="username" required autofocus>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password:</label>
                                <input type="password" class="form-control bg-dark text-light border-secondary" name="password" id="password" required>
                            </div>
                            <div class="d-grid">
                                <input type="submit" class="btn btn-primary" value="Login">
                            </div>
                        </form>
                        <div class="text-center mt-3">
                            <a href="/signup" class="text-decoration-none">Don't have an account? Sign up</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" {% if sri.jquery %}integrity="{{ sri.jquery }}" crossorigin="anonymous"{% else %}crossorigin="anonymous"{% endif %}></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" {% if sri.bootstrap_js %}integrity="{{ sri.bootstrap_js }}" crossorigin="anonymous"{% else %}crossorigin="anonymous"{% endif %}></script>
    <script>
        async function deriveKey(password, saltB64) {
            try {
                const enc = new TextEncoder();
                const passwordKey = await window.crypto.subtle.importKey(
                    "raw",
                    enc.encode(password),
                    { name: "PBKDF2" },
                    false,
                    ["deriveBits"]
                );

                const saltStr = atob(saltB64);
                const salt = new Uint8Array(saltStr.length);
                for (let i = 0; i < saltStr.length; i++) {
                    salt[i] = saltStr.charCodeAt(i);
                }

                const derivedBits = await window.crypto.subtle.deriveBits(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256"
                    },
                    passwordKey,
                    256 
                );

                const derivedArray = new Uint8Array(derivedBits);
                let derivedStr = "";
                for (let i = 0; i < derivedArray.length; i++) {
                    derivedStr += String.fromCharCode(derivedArray[i]);
                }
                return btoa(derivedStr);
            } catch (e) {
                console.error("Derivation failed", e);
                return null;
            }
        }

        $('form').on('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const username = $('#username').val().trim();
            const password = $('#password').val();
            
            if (!username || !password) {
                form.submit(); 
                return;
            }

            if (!window.crypto || !window.crypto.subtle) {
                console.log("Web Crypto API not available. Using server-side derivation.");
                form.submit();
                return;
            }

            try {
                const resp = await fetch(`/auth/salt/${encodeURIComponent(username)}`);
                if (!resp.ok) {
                    console.warn("Could not fetch salt, falling back to server derivation");
                    form.submit();
                    return;
                }
                
                const data = await resp.json();
                const derivedKey = await deriveKey(password, data.salt);
                
                if (derivedKey) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'storage_key',
                        value: derivedKey
                    }).appendTo(form);
                }
            } catch (err) {
                 console.error("Client side derivation process failed", err);
            }

            form.submit();
        });
    </script>
</body>
</html>
